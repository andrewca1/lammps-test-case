log                ${dname}/log.lammps
echo               both
variable           ndim equal 2
dimension          ${ndim}
units              si

# requires a custom version of LAMMPS
# https://github.com/slitvinov/lammps-sph-multiphase
# Built with
# make yes-USER-SPH
# 
# See also
# http://lammps.sandia.gov/doc/Section_start.html#start_3
atom_style         meso/multiphase
include            vars.lmp
boundary          p p p

# Adding a new property - need to be added before simulation box
fix             prop all property/atom d_cA d_dcA ghost yes

# create simulation box
if ${ndim}==2 then &
"variable           pLz    equal  ${dx}" &
"variable           nLz    equal  0" &
"region             box block 0.0 ${Lx}  0.0 ${Ly} ${nLz} ${pLz} units box" &
else &
"region             box block 0.0 ${Lx}  0.0 ${Ly} 0 ${Lz} units box"

# create box with two types of particles (flow and wall)
create_box         2 box

# create flow particles
if ${ndim}==3 then &
"lattice            sc ${dx}" &
else &
"lattice            sq ${dx}"
create_atoms       ${g_type} region box

# set mass of the particles
set                group all meso/rho ${sph_rho}
set                group all mass ${sph_mass}

compute            rho_peratom all meso/rho/atom

# Set region for concentration
region          conc  block ${xconc1} ${xconc2} ${yconc1} ${yconc2} ${nLz} ${pLz} units box

# Concentration set
set             atom * d_dcA 0.0
set		atom * d_cA 0.0
set             region conc d_cA ${cA_init}
fix             concentration_fix all meso/concentrationA

# do full time integration for all particles
fix                integrate_fix_full all meso

variable           sph_mu  equal ${sph_eta}/${sph_rho}
include            settimestep.lmp

comm_modify        vel yes
set                group all meso/rho ${sph_rho}

pair_style         hybrid/overlay sph/rhosum/multiphase 1 sph/taitwater/morris
pair_coeff         * * sph/rhosum/multiphase   ${h}

pair_style         hybrid/overlay sph/concAdiffusion/multiphase sph/rhosum/multiphase 1  sph/taitwater/multiphase 
pair_coeff         1 1 sph/concAdiffusion/multiphase 5.0e-5 0.0 ${h}
pair_coeff         1 2 sph/concAdiffusion/multiphase 0.0 0.0 ${h}
pair_coeff         2 2 sph/concAdiffusion/multiphase 0.0 0.0 ${h}
pair_coeff         * * sph/taitwater/multiphase ${sph_rho} ${sph_c} ${sph_eta} ${sph_gamma} ${h} ${sph_rho_background}
pair_coeff         * * sph/rhosum/multiphase   ${h}

neighbor           0 bin
neigh_modify       delay 0 every 1

dump               dump_txt all custom ${Nfreq} ${dname}/dump.*.dat id type x y z vx vy vz c_rho_peratom d_cA
dump_modify        dump_txt first yes sort id pad 8

# create cylinder
region             rcylinder cylinder z ${xcenter} ${ycenter} ${cyl_r} EDGE EDGE units box
set	           region rcylinder type ${d_type}
group              gcylinder region rcylinder
group	           flow subtract all gcylinder
set		   region rcylinder d_cA 0.0

# fix wall particles
fix                wallim gcylinder setforce 0 0 0
write_data         ${dname}/flow.dat

set                type ${d_type} meso/rho ${sph_rho}
set                type ${g_type} meso/rho ${sph_rho}

variable bodyfx    atom mass*${gx}
fix      bodyfx_id flow addforce v_bodyfx 0.0 0.0 

variable           time equal step*dt
thermo_style       custom step v_time 
thermo             ${Nfreq}

timestep           ${dt}
if "${ndim}==2" then "fix e2d all enforce2d"
# run                $(round(${nT}/dt))

# variable           bin_step equal 2.0/${nx}
variable           bin_step equal 1.0
variable           rrun equal round(${nT}/${dt})

run                ${rrun}
